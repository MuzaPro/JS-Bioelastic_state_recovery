<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bioelastic State Recovery • Developer Docs</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="doc.css">
  <script src="theme.js"></script>
  <style>
    /* Additional styles specific to this documentation page */
    .hero-meta {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .meta-label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Warning Box */
    .warning {
      background: var(--bg-accent);
      border: 2px solid var(--accent-yellow);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem 0;
      position: relative;
      overflow: hidden;
    }

    .warning::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent-yellow);
    }

    .warning strong {
      color: var(--accent-yellow-dark);
      font-weight: 600;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin: 1.5rem 0;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      background: var(--bg-secondary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem 1.25rem;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    th {
      background: var(--bg-code);
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      color: var(--text-secondary);
    }

    td strong {
      color: var(--text-primary);
      font-weight: 500;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Blockquotes */
    blockquote {
      border-left: 4px solid var(--accent-yellow);
      padding-left: 1.5rem;
      margin: 2rem 0;
      font-style: italic;
      color: var(--text-secondary);
      font-size: 1.1rem;
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: 0 12px 12px 0;
    }

    /* Print Styles */
    @media print {
      .header,
      .theme-toggle {
        display: none;
      }

      .container {
        max-width: none;
        padding: 0;
      }

      h1, h2, h3 {
        page-break-after: avoid;
      }

      table, pre, blockquote {
        page-break-inside: avoid;
      }
    }

    /* Responsive adjustments for tables */
    @media (max-width: 768px) {
      .hero-meta {
        flex-direction: column;
        gap: 1rem;
      }

      .table-container {
        font-size: 0.9rem;
      }

      th, td {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="../index.html" class="back-link">
        ← Back to Demo
      </a>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg class="theme-icon" viewBox="0 0 24 24">
          <path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z"/>
        </svg>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="hero">
      <h1>Bioelastic State Recovery</h1>
      <p class="hero-subtitle">Developer Documentation</p>
      <blockquote>A cinematic, interactive demo with intelligent state transitions and compound navigation paths</blockquote>
      
      <div class="hero-meta">
        <div class="meta-item">
          <span class="meta-label">Last updated:</span>
          <span>31 May 2025</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Maintainer:</span>
          <span>Muza Productions</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Version:</span>
          <span>2.1.0</span>
        </div>
      </div>
    </div>
    
    <div class="warning">
      <strong>⚠️ Implementation Update:</strong> This documentation reflects the current advanced state machine with substates, compound transitions, and smart navigation fallbacks.
    </div>
    
    <h2 id="overview">1 · Project Architecture</h2>
    
    <div class="table-container">
      <table>
        <tr><th>Aspect</th><th>Details</th></tr>
        <tr><td><strong>Concept</strong></td><td>5-state interactive journey with substates and intelligent transition routing</td></tr>
        <tr><td><strong>Navigation</strong></td><td>Bottom sticky nav bar with icon-based state switching + compound transition support</td></tr>
        <tr><td><strong>State System</strong></td><td>Primary states (1-5) + substates (3B) + automatic routing through intermediate states</td></tr>
        <tr><td><strong>Transition Logic</strong></td><td>Direct animations where available, compound transitions via intermediate states when needed</td></tr>
        <tr><td><strong>Performance</strong></td><td>Preloaded animations, graceful fallbacks, mobile-optimized with 60fps target</td></tr>
      </table>
    </div>
    
    <h2 id="state-machine">2 · Advanced State Machine</h2>
    
    <h3>State Structure</h3>
    <pre><code class="language-js">const states = {
    1: { title: "Breakthrough Haptic Technology", image: "state1_static.webp" },
    2: { title: "Precision Engineering", image: "state2_static.webp" },
    3: { title: "Force Distribution", image: "state3-static.webp", hasSubstate: true, currentSubstate: "A" },
    "3B": { title: "Force Distribution", image: "state3b-static.webp", hasSubstate: true, currentSubstate: "B" },
    4: { title: "Scalable Haptic Arrays", image: "state4_static.webp" },
    5: { title: "Sensory Feedback", image: "state5_static.webp" }
};

const animations = {
    "1-2": "state1-to-state2.webm",
    "2-1": "state2-to-state1.webm", 
    "1-4": "state1-to-state4.webm",
    "4-1": "state4-to-state1.webm",
    "2-3": "state2-to-state3.webm",
    "3-2": "state3-to-state2.webm",
    "2-4": "state2-to-state4.webm", 
    "4-2": "state4-to-state2.webm",
    "3-3B": "3Ato3B.webm",
    "3B-3": "3Bto3A.webm"
};</code></pre>

    <h3>Intelligent Transition Routing</h3>
    <p>The system automatically routes transitions through intermediate states when direct animations don't exist:</p>
    <ul>
      <li><strong>Direct transitions:</strong> Play available WebM animations</li>
      <li><strong>Compound transitions:</strong> Route via intermediate state (e.g., 1→3 goes 1→2→3)</li>
      <li><strong>Substate handling:</strong> State 3B always routes through 3A before going elsewhere</li>
      <li><strong>Graceful fallbacks:</strong> Instant image swaps when animations fail</li>
    </ul>

    <h3>Current State Graph</h3>
    <pre class="mermaid">
stateDiagram-v2
    [*] --> S1 : page load
    S1 --> S2 : direct animation
    S1 --> S4 : direct animation  
    S2 --> S1 : direct animation
    S2 --> S3 : direct animation
    S2 --> S4 : direct animation
    S3 --> S2 : direct animation
    S3 --> S3B : substate toggle
    S3B --> S3 : substate toggle
    S3B --> S2 : via S3 (compound)
    S4 --> S1 : direct animation
    S4 --> S2 : direct animation
    S1 --> S3 : via S2 (compound)
    S3 --> S1 : via S2 (compound)
    S1 --> S5 : via S2→S4 (compound)
    S3 --> S4 : via S2 (compound)
    S4 --> S5 : planned
    S5 --> S4 : planned
    </pre>

    <h2 id="functions">3 · Core Functions</h2>
    
    <div class="table-container">
      <table>
        <tr><th>Function</th><th>Purpose</th><th>Key Features</th></tr>
        <tr><td><code>setupNavListeners()</code></td><td>Attaches click handlers to bottom nav icons</td><td>Prevents double-clicking during transitions</td></tr>
        <tr><td><code>transitionToState(targetState)</code></td><td>Master transition controller</td><td>Handles direct, compound, and substate transitions</td></tr>
        <tr><td><code>performCompoundTransition(from, via, to)</code></td><td>Routes transitions through intermediate states</td><td>Seamless multi-hop navigation with timing control</td></tr>
        <tr><td><code>toggleState3Substate()</code></td><td>Switches between 3A and 3B views</td><td>Same content, different visual perspective</td></tr>
        <tr><td><code>playTransitionAnimation(path, target)</code></td><td>Handles WebM playback and fallbacks</td><td>Error recovery, proper video/image switching</td></tr>
        <tr><td><code>updateActiveNav()</code></td><td>Manages nav bar highlighting</td><td>Special handling for substates (3B highlights nav item 3)</td></tr>
        <tr><td><code>preloadAnimations()</code></td><td>Background loads all WebM files</td><td>Prevents first-play stuttering</td></tr>
      </table>
    </div>

    <h3>Compound Transition Flow</h3>
    <pre class="mermaid">
sequenceDiagram
    participant UI as Nav Click
    participant TM as transitionToState()
    participant CT as performCompoundTransition()
    participant V1 as Video 1→2
    participant V2 as Video 2→3
    participant IMG as Final Image
    
    UI->>TM: click state 3 (from state 1)
    TM->>TM: check: no direct "1-3" animation
    TM->>CT: route via state 2
    CT->>V1: play "1-2.webm"
    V1-->>CT: ended
    Note over CT: 100ms pause
    CT->>V2: play "2-3.webm" 
    V2-->>CT: ended
    CT->>IMG: load state 3 image
    CT-->>TM: compound transition complete
    TM->>TM: update content & nav
    </pre>

    <h2 id="ui-system">4 · User Interface</h2>
    
    <h3>Navigation Bar</h3>
    <ul>
      <li><strong>Position:</strong> Sticky bottom bar (mobile-first design)</li>
      <li><strong>Icons:</strong> FontAwesome + custom SVG icons for each state</li>
      <li><strong>Active State:</strong> Highlighted with underline accent</li>
      <li><strong>Substate Handling:</strong> State 3B highlights the State 3 nav item</li>
    </ul>

    <h3>State 3 Switch Button</h3>
    <p>When in state 3 or 3B, a "Switch" button appears that toggles between the two perspectives using dedicated transition animations.</p>

    <h3>Responsive Layout</h3>
    <ul>
      <li><strong>Desktop:</strong> Grid layout with sticky visual content</li>
      <li><strong>Mobile:</strong> Single column, visual above text content</li>
      <li><strong>Media Container:</strong> Square aspect ratio using vh units</li>
    </ul>

    <h2 id="extend">5 · Extension Guide</h2>
    
    <h3>Adding a New Primary State</h3>
    <ol>
      <li>Add static image: <code>assets/animations/state-static/stateN_static.webp</code></li>
      <li>Update <code>states</code> object with new entry</li>
      <li>Create transition animations and add to <code>animations</code> object</li>
      <li>Add navigation icon to HTML and update CSS selectors</li>
    </ol>

    <h3>Adding Substates (like 3B)</h3>
    <ol>
      <li>Add <code>hasSubstate: true</code> and <code>currentSubstate</code> to parent state</li>
      <li>Create new state entry with string key (e.g., "3B")</li>
      <li>Add toggle animations to <code>animations</code> object</li>
      <li>The switch button will appear automatically</li>
    </ol>

    <h3>Adding New Transition Paths</h3>
    <p>If direct animation doesn't exist, the system will automatically route through the most logical intermediate state (usually state 2). To add custom routing:</p>
    <pre><code class="language-js">// In performCompoundTransition(), add custom routing logic
if (currentState === 4 && targetState === 3) {
    await performCompoundTransition(currentState, 2, targetState);
}</code></pre>

    <h3>Performance Optimizations</h3>
    <ul>
      <li><strong>Video Compression:</strong> Target 1-2MB per WebM file</li>
      <li><strong>CDN Hosting:</strong> Move assets to Cloudflare R2 for global edge caching</li>
      <li><strong>Lazy Loading:</strong> Load animations only when approaching that transition</li>
      <li><strong>Format Fallbacks:</strong> Add MP4 versions for older browser support</li>
    </ul>

    <h2 id="debugging">6 · Debugging & Troubleshooting</h2>
    
    <h3>Common Issues</h3>
    <div class="table-container">
      <table>
        <tr><th>Issue</th><th>Cause</th><th>Solution</th></tr>
        <tr><td>White flash during transition</td><td>Image not preloaded</td><td>Check image paths, ensure preloading completes</td></tr>
        <tr><td>Stuck in transitioning state</td><td>Error in animation playback</td><td>Check browser console, verify WebM format</td></tr>
        <tr><td>Nav not highlighting correctly</td><td>Substate logic issue</td><td>Check <code>updateActiveNav()</code> special cases</td></tr>
        <tr><td>Compound transition breaks</td><td>Missing intermediate animation</td><td>Add fallback or create missing WebM file</td></tr>
      </table>
    </div>

    <h3>Debug Console Output</h3>
    <p>The system logs transition paths:</p>
    <pre><code>// Normal direct transition
"Playing direct transition: 1 → 2"

// Compound transition  
"Using compound transition: 1 → 2 → 3"
"First leg complete: 1 → 2"
"Second leg complete: 2 → 3"

// Substate toggle
"Toggling state 3 substate: A → B"</code></pre>

    <h2 id="technical-specs">7 · Technical Specifications</h2>
    
    <div class="table-container">
      <table>
        <tr><th>Component</th><th>Specification</th></tr>
        <tr><td><strong>Video Format</strong></td><td>WebM (VP9 codec, 25fps, 1920×1080)</td></tr>
        <tr><td><strong>Image Format</strong></td><td>WebP (optimized for quality/size balance)</td></tr>
        <tr><td><strong>Transition Duration</strong></td><td>1 second per animation</td></tr>
        <tr><td><strong>Browser Support</strong></td><td>Chrome 88+, Firefox 85+, Safari 14+</td></tr>
        <tr><td><strong>Mobile Support</strong></td><td>iOS 14+, Android 8+</td></tr>
        <tr><td><strong>Dependencies</strong></td><td>None (vanilla JavaScript)</td></tr>
      </table>
    </div>

    <hr />
    <p><em>For implementation questions or feature requests, contact the development team or open an issue in the repository.</em></p>
  </div>
</body>
</html>